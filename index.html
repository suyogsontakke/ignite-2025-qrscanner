<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IGNITE 2025 | Ticket Verifier</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Bebas+Neue&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="https://i.postimg.cc/HkXcxcgX/1758263167091.png">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/HkXcxcgX/1758263167091.png">
    
    <style>
        :root {
            --bg-dark: #0B120E;
            --bg-light: #111A15;
            --primary-green: #16FF00;
            --text-primary: #f8fafc;
            --text-secondary: #a0aec0;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            overflow-y: auto;
            color: var(--text-secondary);
        }

        #scanner-container { position: relative; width: 100%; padding-top: 100%; overflow: hidden; border-radius: 1.5rem; }
        #scanner-video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        #viewfinder { position: absolute; top: 10%; left: 10%; width: 80%; height: 80%; box-shadow: 0 0 0 400px rgba(11, 26, 21, 0.7); border: 2px solid rgba(255, 255, 255, 0.8); border-radius: 1rem; }
        #viewfinder::before, #viewfinder::after { content: ''; position: absolute; width: 40px; height: 40px; }
        #viewfinder::before { top: -2px; left: -2px; border-top: 4px solid var(--primary-green); border-left: 4px solid var(--primary-green); border-radius: 1rem 0 0 0; }
        #viewfinder::after { top: -2px; right: -2px; border-top: 4px solid var(--primary-green); border-right: 4px solid var(--primary-green); border-radius: 0 1rem 0 0; }
        .viewfinder-bottom::before, .viewfinder-bottom::after { content: ''; position: absolute; width: 40px; height: 40px; }
        .viewfinder-bottom::before { bottom: -2px; left: -2px; border-bottom: 4px solid var(--primary-green); border-left: 4px solid var(--primary-green); border-radius: 0 0 0 1rem; }
        .viewfinder-bottom::after { bottom: -2px; right: -2px; border-bottom: 4px solid var(--primary-green); border-right: 4px solid var(--primary-green); border-radius: 0 0 1rem 0; }
        
        .scan-line { 
            position: absolute; top: 0; left: 5%; width: 90%; height: 3px; 
            background: linear-gradient(90deg, transparent, rgba(22, 255, 0, 0.8), transparent);
            box-shadow: 0 0 10px rgba(22, 255, 0, 0.7);
            border-radius: 3px; 
            animation: scan 2.5s infinite ease-in-out; 
        }
        @keyframes scan { 
            0% { transform: translateY(10px); } 
            50% { transform: translateY(calc(100% - 10px)); } 
            100% { transform: translateY(10px); } 
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .modal-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes slideDownIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .log-entry-animation { animation: slideDownIn 0.4s ease-out forwards; }

        .log-list::-webkit-scrollbar { width: 8px; }
        .log-list::-webkit-scrollbar-track { background: var(--bg-dark); border-radius: 10px; }
        .log-list::-webkit-scrollbar-thumb { background: var(--primary-green); border-radius: 10px; }
        .log-list::-webkit-scrollbar-thumb:hover { background: #12e000; }
        .neon-text { color: var(--primary-green); text-shadow: 0 0 5px var(--primary-green), 0 0 10px var(--primary-green); }
    </style>
</head>
<body class="h-full flex flex-col items-center justify-start p-4 md:py-8">

    <div id="login-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-bg-dark/95 backdrop-blur-sm">
        <div class="w-full max-w-xs p-8 space-y-6 rounded-lg shadow-2xl bg-bg-light">
            <h2 class="text-2xl font-bold text-center text-text-primary">Verifier Access</h2>
            <form id="login-form">
                <div class="space-y-4">
                    <div>
                        <label for="password" class="sr-only">Password</label>
                        <input id="password" name="password" type="password" required class="w-full px-4 py-2 text-white transition duration-200 bg-gray-800 border border-gray-700 rounded-md appearance-none focus:outline-none focus:ring-2 focus:ring-[var(--primary-green)]" placeholder="Enter Admin Password">
                    </div>
                    <p id="login-error-message" class="text-sm text-center text-red-500 hidden">Incorrect Password.</p>
                    <button type="submit" class="w-full px-4 py-2 font-bold text-black transition-colors duration-200 transform rounded-md bg-[var(--primary-green)] hover:bg-green-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-bg-light focus:ring-[var(--primary-green)]">
                        Login
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="verifier-app" class="w-full max-w-md mx-auto hidden">
        <div class="bg-bg-light rounded-2xl shadow-2xl overflow-hidden text-center p-6 md:p-8">
            <h1 class="text-5xl font-bold neon-text" style="font-family: 'Bebas Neue', cursive;">Ticket Verifier</h1>
            <p class="text-text-secondary mt-2 mb-6">For IGNITE 2025 ðŸ”¥</p>
            <div id="scanner-container" class="bg-black">
                <video id="scanner-video" playsinline></video>
                <div id="viewfinder"><div class="viewfinder-bottom"></div><div class="scan-line"></div></div>
            </div>
            <canvas id="scanner-canvas" class="hidden"></canvas>
            <p id="scan-status-message" class="mt-4 font-medium text-text-primary">Requesting camera access...</p>
            <div class="my-6 flex items-center"><hr class="flex-grow border-t border-gray-700"><span class="px-3 text-gray-400 text-sm font-semibold">OR</span><hr class="flex-grow border-t border-gray-700"></div>
            <label for="file-input" class="w-full cursor-pointer bg-gray-700 text-text-primary font-bold py-3 px-4 rounded-lg hover:bg-gray-600 focus:outline-none focus:ring-4 focus:ring-green-500/50 transition-all transform hover:scale-105 shadow-lg flex items-center justify-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                <span>Scan From Photo</span>
            </label>
            <input type="file" id="file-input" accept="image/*" class="hidden">
        </div>

        <div class="bg-bg-light rounded-2xl shadow-2xl text-left p-6 md:p-8 mt-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-white">Verification Log</h2>
                <div class="text-right">
                    <p class="font-semibold text-gray-300">Checked-In</p>
                    <p class="text-3xl font-bold text-green-500" id="log-count">0</p>
                </div>
            </div>
            <div id="log-list" class="log-list max-h-64 overflow-y-auto pr-2 space-y-3">
                <p id="log-placeholder" class="text-center text-gray-400 py-8">No attendees verified yet.</p>
            </div>
            <div class="mt-4 pt-4 border-t border-gray-700">
                <button id="clear-log-btn" class="w-full text-sm bg-red-800/50 text-red-300 font-bold py-2 px-4 rounded-lg hover:bg-red-800 hover:text-red-200 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    Clear Selected (0)
                </button>
            </div>
        </div>
    </div>

    <div id="result-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-bg-light rounded-2xl shadow-xl max-w-sm w-full p-8 text-center modal-fade-in border border-gray-700">
              <div id="result-icon"></div>
              <h3 id="result-title" class="text-2xl font-bold mt-4"></h3>
              <div id="attendee-details" class="mt-4 text-left space-y-2 hidden">
                  <div><p class="text-sm font-medium text-gray-400">Name</p><p id="attendee-name" class="text-xl font-semibold text-white"></p></div>
                  <div><p class="text-sm font-medium text-gray-400">Email</p><p id="attendee-email" class="text-lg text-gray-300"></p></div>
                  <div><p class="text-sm font-medium text-gray-400">Ticket ID</p><p id="attendee-id" class="text-sm text-gray-500 font-mono"></p></div>
                  <div id="scan-time-wrapper" class="hidden pt-2 mt-2 border-t border-gray-700"><p class="text-sm font-medium text-gray-400">Original Scan Time</p><p id="scan-time" class="text-lg text-gray-300"></p></div>
              </div>
              <button id="modal-close-btn" class="mt-8 bg-green-600 text-black font-semibold py-3 px-8 rounded-lg hover:bg-green-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-bg-light focus:ring-green-500 w-full">Scan Next Ticket</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // --- CHANGED: Using secure Email/Password login, not anonymous ---
        import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, serverTimestamp, collection, query, where, onSnapshot, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            // --- IMPORTANT: Fill in your Firebase config from index.html ---
            apiKey: "AIzaSyAPd9loQiNnouyKtxfwv-s7jcPzpZKmhys", // From your other files
            authDomain: "ignite-event-2025-nagpur.firebaseapp.com",
            projectId: "ignite-event-2025-nagpur",
            storageBucket: "ignite-event-2025-nagpur.appspot.com",
            messagingSenderId: "480552824914",
            appId: "1:480552824914:web:d67e8c9f208c67ac7fef8b"
        };
        // --- DELETED: Insecure client-side password ---
        
        // --- CHANGED: Firebase is initialized first ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let stream = null;
        const checkedInAttendees = {};

        // UI Elements
        const loginModal = document.getElementById('login-modal');
        const loginForm = document.getElementById('login-form');
        const loginErrorMessage = document.getElementById('login-error-message');
        const verifierApp = document.getElementById('verifier-app');
        
        const video = document.getElementById('scanner-video');
        const canvasElement = document.getElementById('scanner-canvas');
        const canvas = canvasElement.getContext('2d', { willReadFrequently: true });
        const scanStatusMessage = document.getElementById('scan-status-message');
        const fileInput = document.getElementById('file-input');
        const resultModal = document.getElementById('result-modal');
        const resultIcon = document.getElementById('result-icon');
        const resultTitle = document.getElementById('result-title');
        const attendeeDetails = document.getElementById('attendee-details');
        const attendeeName = document.getElementById('attendee-name');
        const attendeeEmail = document.getElementById('attendee-email');
        const attendeeId = document.getElementById('attendee-id');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const scanTimeWrapper = document.getElementById('scan-time-wrapper');
        const scanTime = document.getElementById('scan-time');
        const logCount = document.getElementById('log-count');
        const logList = document.getElementById('log-list');
        const logPlaceholder = document.getElementById('log-placeholder');
        
        const clearLogBtn = document.getElementById('clear-log-btn');

        // --- DELETED: Password Modal UI Elements ---

        // --- NEW: Secure Login Handler ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loginErrorMessage.classList.add('hidden');
            
            // -----------------------------------------------------------------
            // --- !!! IMPORTANT !!! ---
            // --- SET THIS TO THE ADMIN EMAIL YOU CREATED IN FIREBASE AUTH ---
            const email = "suyogop12@gmail.com"; 
            // -----------------------------------------------------------------
            
            const password = e.target.password.value;

            try {
                // Try to sign in with the real Firebase account
                await signInWithEmailAndPassword(auth, email, password);
                
                // On success: Hide login, show app, start scanner
                loginModal.style.display = 'none';
                verifierApp.classList.remove('hidden');
                
                // Now that we are logged in as admin, start app
                initializeAppAndScanner(); 
                
            } catch (error) {
                // On failure:
                console.error("Admin Login Error:", error.code);
                if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password') {
                    loginErrorMessage.textContent = "Incorrect password. Please try again.";
                } else {
                    loginErrorMessage.textContent = "An error occurred. Check console.";
                }
                loginErrorMessage.classList.remove('hidden');
                e.target.password.value = '';
            }
        });


        function stopScanner() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            video.pause();
            video.srcObject = null;
            stream = null;
        }

        async function startScanner() {
            try {
                stopScanner();
                scanStatusMessage.textContent = "Initializing camera...";
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    scanStatusMessage.textContent = "Point camera at a QR code";
                    requestAnimationFrame(tick);
                };
            } catch (err) {
                console.error("Camera Error:", err);
                scanStatusMessage.textContent = "Camera access denied.";
            }
        }
        
        function tick() {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvasElement.height = video.videoHeight;
                canvasElement.width = video.videoWidth;
                canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
                const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });
                if (code) {
                    handleQrCode(code.data);
                    return;
                }
            }
            if (stream && stream.active) {
                requestAnimationFrame(tick);
            }
        }

        async function handleQrCode(data) {
            stopScanner();
            scanStatusMessage.textContent = "QR Code Detected! Verifying...";
            
            try {
                const ticketData = JSON.parse(data);
                if (!ticketData.id) {
                    showResult('error', 'Invalid QR Format', null);
                    return;
                }

                // ONLY CHECK 'approved_registrations' collection
                const docRef = doc(db, 'approved_registrations', ticketData.id);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const attendee = docSnap.data();
                    const displayData = { ...attendee, id: docSnap.id };

                    if (attendee.checkedIn) {
                        showResult('warning', 'Already Checked In', displayData);
                    } else {
                        // Secure rule allows this update because we are admin
                        await updateDoc(docRef, {
                            checkedIn: true,
                            checkedInAt: serverTimestamp()
                        });
                        
                        const updatedData = { ...displayData, checkedIn: true, checkedInAt: { toDate: () => new Date() } };
                        checkedInAttendees[docSnap.id] = updatedData;
                        renderCombinedLog();
                        
                        showResult('success', 'Access Granted', displayData);
                    }
                } else {
                    showResult('error', 'Invalid Ticket', { name: ticketData.name || "Unknown", email: "N/A", id: 'NOT FOUND' });
                }

            } catch (error) {
                console.error("Verification error:", error);
                showResult('error', 'Invalid QR Code', null);
            }
        }

        fileInput.addEventListener('change', e => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = event => {
                const img = new Image();
                img.onload = () => {
                    canvasElement.width = img.width;
                    canvasElement.height = img.height;
                    canvas.drawImage(img, 0, 0, img.width, img.height);
                    const imageData = canvas.getImageData(0, 0, img.width, img.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height);
                    if (code) handleQrCode(code.data);
                    else showResult('error', 'No QR Code Found', null);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        function showResult(type, title, data) {
            resultTitle.textContent = title;
            attendeeDetails.classList.add('hidden');
            scanTimeWrapper.classList.add('hidden');
            
            const resultClasses = {
                success: 'text-green-400',
                error: 'text-red-500',
                warning: 'text-orange-400'
            };
            resultTitle.className = `text-2xl font-bold mt-4 ${resultClasses[type]}`;

            const icons = {
                success: `<svg class="w-20 h-20 mx-auto text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
                error: `<svg class="w-20 h-20 mx-auto text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
                warning: `<svg class="w-20 h-20 mx-auto text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>`
            };
            resultIcon.innerHTML = icons[type];
            
            if (data) {
                attendeeName.textContent = data.name;
                attendeeEmail.textContent = data.email;
                attendeeId.textContent = data.id;
                attendeeDetails.classList.remove('hidden');
                if (type === 'warning' && data.checkedInAt) {
                    scanTime.textContent = data.checkedInAt.toDate().toLocaleString();
                    scanTimeWrapper.classList.remove('hidden');
                }
            }
            resultModal.classList.remove('hidden');
        }

        modalCloseBtn.addEventListener('click', () => {
            resultModal.classList.add('hidden');
            fileInput.value = '';
            startScanner();
        });

        // --- CHANGED: This function now just starts the listeners and scanner ---
        // It's called AFTER successful login
        function initializeAppAndScanner() {
            try {
                console.log("Firebase Verifier Initialized by Admin.");
                setupLogListener();
                startScanner();
            } catch (error) {
                console.error("Error starting app:", error);
                scanStatusMessage.textContent = "App initialization failed.";
            }
        }
        
        function renderCombinedLog() {
            const checkIns = Object.values(checkedInAttendees);
            logCount.textContent = checkIns.length;
            
            logPlaceholder.classList.toggle('hidden', checkIns.length > 0);
            logList.innerHTML = '';

            checkIns.sort((a, b) => (b.checkedInAt?.toDate() || 0) - (a.checkedInAt?.toDate() || 0));

            checkIns.forEach(entry => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'log-entry-animation p-3 bg-gray-800/50 rounded-lg flex items-center space-x-3 border border-gray-700';
                const icon = `<svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                
                entryDiv.innerHTML = `
                    <div class="flex-shrink-0">
                        <input type="checkbox" class="log-checkbox h-5 w-5 rounded bg-gray-700 border-gray-600 text-green-500 focus:ring-green-500/50" data-id="${entry.id}">
                    </div>
                    <div class="flex-shrink-0">${icon}</div>
                    <div class="flex-grow min-w-0">
                        <p class="font-semibold text-white truncate">${entry.name}</p>
                        <p class="text-xs text-gray-400 truncate">ID: ${entry.id.substring(0,8)}...</p>
                    </div>
                    <div class="text-right text-sm text-gray-400 flex-shrink-0">
                        ${entry.checkedInAt ? entry.checkedInAt.toDate().toLocaleTimeString() : ''}
                    </div>`;
                logList.appendChild(entryDiv);
            });
            // After re-rendering, update the button state
            updateClearButtonCount();
        }
        
        function setupLogListener() {
            const q = query(collection(db, 'approved_registrations'), where('checkedIn', '==', true));
            onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const docData = { id: change.doc.id, ...change.doc.data() };
                    if (change.type === "added" || change.type === "modified") {
                        checkedInAttendees[change.doc.id] = docData;
                    } else if (change.type === "removed") {
                        delete checkedInAttendees[change.doc.id];
                    }
                });
                renderCombinedLog();
            }, (error) => console.error(`Firestore listener error:`, error));
        }

        async function clearSelectedLogs() {
            const selectedLogs = document.querySelectorAll('.log-checkbox:checked');
            if (selectedLogs.length === 0) return;

            // Secure rule allows this writeBatch because we are admin
            try {
                const batch = writeBatch(db);
                selectedLogs.forEach(checkbox => {
                    const docRef = doc(db, 'approved_registrations', checkbox.dataset.id);
                    // Reset the check-in status
                    batch.update(docRef, { checkedIn: false, checkedInAt: null }); 
                });
                await batch.commit();
                alert(`Success! ${selectedLogs.length} log(s) cleared.`);
            } catch (error) {
                console.error("Error clearing log:", error);
                alert(`Error: Could not clear logs. ${error.message}`);
            }
        }

        function updateClearButtonCount() {
            const selectedCount = document.querySelectorAll('.log-checkbox:checked').length;
            clearLogBtn.textContent = `Clear Selected (${selectedCount})`;
            clearLogBtn.disabled = selectedCount === 0;
        }

        logList.addEventListener('change', (e) => {
            if (e.target.classList.contains('log-checkbox')) {
                updateClearButtonCount();
            }
        });

        // --- CHANGED: No longer shows password modal ---
        clearLogBtn.addEventListener('click', async () => {
            const selectedCount = document.querySelectorAll('.log-checkbox:checked').length;
            if (selectedCount > 0) {
                if (confirm(`Are you sure you want to clear ${selectedCount} selected log(s)? This will reset their check-in status.`)) {
                    await clearSelectedLogs();
                }
            }
        });

        // --- DELETED: All listeners for the insecure password modal ---

        // --- NOTE: App start is now handled by the login form submit listener ---
        // document.addEventListener('DOMContentLoaded', initializeAppAndScanner); // This is no longer needed
    </script>
</body>
</html>


